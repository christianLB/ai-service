# Makefile.migrations - Sistema de migraciones de base de datos
# GestiÃ³n automatizada de schemas con Alembic

include .make.env

# Colores
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
RED := \033[0;31m
NC := \033[0m

# =============================================================================
# ğŸ”„ COMANDOS DE MIGRACIÃ“N
# =============================================================================

.PHONY: migrate-init
migrate-init: ## Inicializar Alembic en el proyecto
	@echo "$(BLUE)ğŸ”§ Inicializando Alembic...$(NC)"
	@if [ ! -d "alembic" ]; then \
		pip install alembic psycopg2-binary; \
		alembic init alembic; \
		echo "$(GREEN)âœ“ Alembic inicializado$(NC)"; \
	else \
		echo "$(YELLOW)âš  Alembic ya estÃ¡ inicializado$(NC)"; \
	fi

.PHONY: migrate-create
migrate-create: ## Crear nueva migraciÃ³n (uso: make migrate-create NAME="descripcion")
	@if [ -z "$(NAME)" ]; then \
		echo "$(RED)Error: Especifica NAME=\"descripcion de la migraciÃ³n\"$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“ Creando migraciÃ³n: $(NAME)$(NC)"
	@alembic revision -m "$(NAME)"
	@echo "$(GREEN)âœ“ MigraciÃ³n creada$(NC)"

.PHONY: migrate-auto
migrate-auto: ## Generar migraciÃ³n automÃ¡tica desde modelos
	@echo "$(BLUE)ğŸ” Generando migraciÃ³n automÃ¡tica...$(NC)"
	@alembic revision --autogenerate -m "auto_$(shell date +%Y%m%d_%H%M%S)"
	@echo "$(GREEN)âœ“ MigraciÃ³n generada$(NC)"

.PHONY: migrate-up
migrate-up: ## Aplicar migraciones pendientes
	@echo "$(BLUE)â¬†ï¸  Aplicando migraciones...$(NC)"
	@alembic upgrade head
	@echo "$(GREEN)âœ“ Migraciones aplicadas$(NC)"

.PHONY: migrate-down
migrate-down: ## Revertir Ãºltima migraciÃ³n
	@echo "$(YELLOW)â¬‡ï¸  Revirtiendo Ãºltima migraciÃ³n...$(NC)"
	@alembic downgrade -1
	@echo "$(GREEN)âœ“ MigraciÃ³n revertida$(NC)"

.PHONY: migrate-status
migrate-status: ## Ver estado de migraciones
	@echo "$(BLUE)ğŸ“Š Estado de migraciones:$(NC)"
	@alembic current
	@echo ""
	@echo "$(BLUE)Historial:$(NC)"
	@alembic history --verbose

.PHONY: migrate-sync-dev-to-prod
migrate-sync-dev-to-prod: ## Sincronizar schema de dev a prod
	@echo "$(YELLOW)ğŸ”„ Sincronizando dev â†’ prod$(NC)"
	@echo "$(RED)âš ï¸  ADVERTENCIA: Esto actualizarÃ¡ el schema de PRODUCCIÃ“N$(NC)"
	@echo "Â¿Continuar? (s/N):"
	@read CONFIRM && [ "$$CONFIRM" = "s" ] || (echo "$(GREEN)Cancelado$(NC)" && exit 1)
	@echo "$(BLUE)1. Generando SQL de diferencias...$(NC)"
	@docker exec ai-service-postgres-1 pg_dump -U ai_user -d ai_service --schema-only > /tmp/dev-schema.sql
	@echo "$(BLUE)2. Aplicando en producciÃ³n...$(NC)"
	@$(MAKE) -f Makefile.production prod-apply-schema
	@echo "$(GREEN)âœ“ SincronizaciÃ³n completada$(NC)"

.PHONY: migrate-diff
migrate-diff: ## Ver diferencias entre dev y prod
	@echo "$(BLUE)ğŸ” Analizando diferencias...$(NC)"
	@$(MAKE) -f Makefile.compare diff-schema

# =============================================================================
# ğŸ—„ï¸ COMANDOS DE SCHEMA
# =============================================================================

.PHONY: schema-dump
schema-dump: ## Exportar schema actual a SQL
	@echo "$(BLUE)ğŸ“¥ Exportando schema...$(NC)"
	@docker exec ai-service-postgres-1 pg_dump -U ai_user -d ai_service --schema-only > schema-$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ“ Schema exportado$(NC)"

.PHONY: schema-load
schema-load: ## Cargar schema desde archivo (uso: make schema-load FILE=schema.sql)
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)Error: Especifica FILE=archivo.sql$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“¤ Cargando schema desde $(FILE)...$(NC)"
	@docker exec -i ai-service-postgres-1 psql -U ai_user -d ai_service < $(FILE)
	@echo "$(GREEN)âœ“ Schema cargado$(NC)"

.PHONY: schema-validate
schema-validate: ## Validar schema contra modelos
	@echo "$(BLUE)âœ… Validando schema...$(NC)"
	@python scripts/validate_schema.py || echo "$(RED)âœ— ValidaciÃ³n fallÃ³$(NC)"

# =============================================================================
# ğŸš€ COMANDOS DE DEPLOY
# =============================================================================

.PHONY: deploy-check
deploy-check: ## Verificar si hay migraciones pendientes antes de deploy
	@echo "$(BLUE)ğŸ” Verificando migraciones pendientes...$(NC)"
	@if [ "$$(alembic current 2>/dev/null | grep -c head)" -eq 0 ]; then \
		echo "$(RED)âœ— Hay migraciones pendientes$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)âœ“ Todas las migraciones aplicadas$(NC)"; \
	fi

.PHONY: deploy-migrate
deploy-migrate: ## Aplicar migraciones en producciÃ³n
	@echo "$(YELLOW)ğŸš€ Aplicando migraciones en PRODUCCIÃ“N$(NC)"
	@echo "$(RED)âš ï¸  AsegÃºrate de haber hecho backup$(NC)"
	@echo "Â¿Continuar? (s/N):"
	@read CONFIRM && [ "$$CONFIRM" = "s" ] || (echo "$(GREEN)Cancelado$(NC)" && exit 1)
	@$(MAKE) -f Makefile.production prod-backup
	@echo "$(BLUE)Aplicando migraciones...$(NC)"
	# AquÃ­ ejecutarÃ­as alembic en producciÃ³n
	@echo "$(GREEN)âœ“ Migraciones aplicadas en producciÃ³n$(NC)"

# =============================================================================
# Ayuda
# =============================================================================

.PHONY: help
help: ## Mostrar esta ayuda
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘              SISTEMA DE MIGRACIONES DE BD                     â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Flujo tÃ­pico:$(NC)"
	@echo "  1. make migrate-create NAME=\"add_new_feature\""
	@echo "  2. Editar alembic/versions/XXX_add_new_feature.py"
	@echo "  3. make migrate-up"
	@echo "  4. make migrate-sync-dev-to-prod"

.DEFAULT_GOAL := help