# Makefile para MCP Bridge
# GestiÃ³n del servidor MCP Bridge

-include .make.env

# Variables
MCP_PATH ?= /volume1/docker/ai-service-mcp
MCP_PORT ?= 8080
REMOTE_EXEC := ./scripts/remote-exec.sh

# Colores
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m

# =============================================================================
# ğŸŒ‰ MCP BRIDGE - COMANDOS PRINCIPALES
# =============================================================================

.PHONY: mcp-deploy
mcp-deploy: ## ğŸš€ Desplegar MCP Bridge en NAS
	@echo "$(BLUE)ğŸš€ Desplegando MCP Bridge...$(NC)"
	@./scripts/deploy-mcp-final.sh

.PHONY: mcp-deploy-secure
mcp-deploy-secure: ## ğŸ” Despliegue seguro sin exponer secretos
	@echo "$(BLUE)ğŸ” Despliegue seguro de MCP Bridge...$(NC)"
	@cd mcp-bridge/scripts && ./deploy-secure.sh

.PHONY: mcp-setup-secure
mcp-setup-secure: ## ğŸ”‘ Generar configuraciÃ³n segura
	@echo "$(BLUE)ğŸ”‘ Generando configuraciÃ³n segura...$(NC)"
	@cd mcp-bridge/scripts && ./secure-setup.sh --production

.PHONY: mcp-validate-config
mcp-validate-config: ## âœ… Validar configuraciÃ³n
	@cd mcp-bridge/scripts && ./validate-config.sh --production

.PHONY: mcp-backup-config
mcp-backup-config: ## ğŸ’¾ Crear backup encriptado de configuraciÃ³n
	@cd mcp-bridge/scripts && ./backup-config.sh --production

.PHONY: mcp-test-secure
mcp-test-secure: ## ğŸ§ª Testing sin mostrar credenciales
	@echo "$(BLUE)ğŸ§ª Testing seguro de MCP Bridge...$(NC)"
	@cd mcp-bridge/scripts && ./test-production.sh

.PHONY: mcp-validate-deployment
mcp-validate-deployment: ## ğŸ” ValidaciÃ³n completa del despliegue
	@cd mcp-bridge/scripts && ./validate-deployment.sh

.PHONY: mcp-build
mcp-build: ## ğŸ—ï¸ Construir MCP Bridge localmente
	@echo "$(BLUE)ğŸ—ï¸ Construyendo MCP Bridge...$(NC)"
	@cd mcp-bridge && npm install && npm run build

.PHONY: mcp-test
mcp-test: ## ğŸ§ª Testear MCP Bridge localmente
	@echo "$(BLUE)ğŸ§ª Testeando MCP Bridge...$(NC)"
	@cd mcp-bridge && npm test

.PHONY: mcp-logs
mcp-logs: ## ğŸ“‹ Ver logs de MCP Bridge en producciÃ³n
	@echo "$(BLUE)ğŸ“‹ Logs de MCP Bridge...$(NC)"
	@$(REMOTE_EXEC) docker logs -f mcp-bridge --tail 100

.PHONY: mcp-status
mcp-status: ## ğŸ“Š Estado de MCP Bridge
	@echo "$(BLUE)ğŸ“Š Estado de MCP Bridge...$(NC)"
	@$(REMOTE_EXEC) docker ps | grep mcp-bridge || echo "$(RED)âŒ MCP Bridge no estÃ¡ corriendo$(NC)"
	@echo ""
	@echo "$(YELLOW)Testing health endpoint...$(NC)"
	@curl -s http://$(NAS_HOST):$(MCP_PORT)/health | jq . || echo "$(RED)âŒ Health check failed$(NC)"

.PHONY: mcp-restart
mcp-restart: ## ğŸ”„ Reiniciar MCP Bridge
	@echo "$(BLUE)ğŸ”„ Reiniciando MCP Bridge...$(NC)"
	@$(REMOTE_EXEC) "cd $(MCP_PATH) && docker-compose -f src/docker-compose.mcp.yml restart"

.PHONY: mcp-stop
mcp-stop: ## ğŸ›‘ Detener MCP Bridge
	@echo "$(RED)ğŸ›‘ Deteniendo MCP Bridge...$(NC)"
	@$(REMOTE_EXEC) "cd $(MCP_PATH) && docker-compose -f src/docker-compose.mcp.yml down"

.PHONY: mcp-tools
mcp-tools: ## ğŸ”§ Listar herramientas MCP disponibles
	@echo "$(BLUE)ğŸ”§ Herramientas MCP disponibles:$(NC)"
	@cd mcp-bridge && python3 scripts/mcp-client.py list

.PHONY: mcp-test-tool
mcp-test-tool: ## ğŸ¯ Probar una herramienta MCP (uso: make mcp-test-tool TOOL=health_check)
	@echo "$(BLUE)ğŸ¯ Probando herramienta: $(TOOL)$(NC)"
	@cd mcp-bridge && python3 scripts/mcp-client.py execute $(TOOL)

.PHONY: mcp-generate-keys
mcp-generate-keys: ## ğŸ” Generar claves API para MCP
	@echo "$(BLUE)ğŸ” Generando claves API...$(NC)"
	@cd mcp-bridge && ./scripts/generate-api-keys.sh

.PHONY: mcp-backup
mcp-backup: ## ğŸ’¾ Backup de configuraciÃ³n MCP
	@echo "$(BLUE)ğŸ’¾ Creando backup de MCP...$(NC)"
	@$(REMOTE_EXEC) "cd $(MCP_PATH) && tar czf mcp-backup-$$(date +%Y%m%d-%H%M%S).tar.gz config/ logs/"
	@echo "$(GREEN)âœ… Backup creado$(NC)"

.PHONY: mcp-clean-logs
mcp-clean-logs: ## ğŸ§¹ Limpiar logs antiguos de MCP
	@echo "$(YELLOW)ğŸ§¹ Limpiando logs antiguos...$(NC)"
	@$(REMOTE_EXEC) "find $(MCP_PATH)/logs -type f -name '*.log' -mtime +7 -delete"
	@echo "$(GREEN)âœ… Logs limpiados$(NC)"

# Secure workflow
.PHONY: mcp-secure-workflow
mcp-secure-workflow: ## ğŸš€ Flujo completo seguro (setup â†’ validate â†’ deploy â†’ test)
	@echo "$(BLUE)ğŸš€ Iniciando flujo seguro completo...$(NC)"
	@$(MAKE) -f Makefile.mcp mcp-setup-secure
	@echo ""
	@$(MAKE) -f Makefile.mcp mcp-validate-config
	@echo ""
	@echo "$(YELLOW)âš ï¸  Revise la configuraciÃ³n antes de continuar$(NC)"
	@read -p "Â¿Continuar con el despliegue? (y/N): " -n 1 -r; \
	echo ""; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(MAKE) -f Makefile.mcp mcp-backup-config; \
		echo ""; \
		$(MAKE) -f Makefile.mcp mcp-deploy-secure; \
		echo ""; \
		$(MAKE) -f Makefile.mcp mcp-test-secure; \
		echo ""; \
		$(MAKE) -f Makefile.mcp mcp-validate-deployment; \
	else \
		echo "$(YELLOW)Despliegue cancelado$(NC)"; \
	fi

# Rollback
.PHONY: mcp-rollback
mcp-rollback: ## ğŸ”„ Rollback seguro
	@echo "$(BLUE)ğŸ”„ Ejecutando rollback...$(NC)"
	@cd mcp-bridge/scripts && ./rollback.sh

# Security audit
.PHONY: mcp-audit
mcp-audit: ## ğŸ” AuditorÃ­a de seguridad
	@echo "$(BLUE)ğŸ” Ejecutando auditorÃ­a de seguridad...$(NC)"
	@cd mcp-bridge/scripts && ./security-audit.sh

# Help
.PHONY: mcp-help
mcp-help: ## â“ Mostrar ayuda de MCP
	@echo "$(BLUE)MCP Bridge - Comandos disponibles:$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos Seguros (Recomendados):$(NC)"
	@grep -E '^mcp-.*secure.*:.*?## .*$$' Makefile.mcp | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)ConfiguraciÃ³n y ValidaciÃ³n:$(NC)"
	@grep -E '^mcp-(setup|validate|backup|audit).*:.*?## .*$$' Makefile.mcp | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Operaciones:$(NC)"
	@grep -E '^mcp-(deploy|test|status|logs|restart|stop).*:.*?## .*$$' Makefile.mcp | grep -v secure | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Mantenimiento:$(NC)"
	@grep -E '^mcp-(backup|clean|rollback).*:.*?## .*$$' Makefile.mcp | grep -v config | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-25s$(NC) %s\n", $$1, $$2}'