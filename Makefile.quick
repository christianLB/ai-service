# Makefile.quick - Comandos rÃ¡pidos y de emergencia
# Atajos Ãºtiles y procedimientos de emergencia

include .make.env

# Colores
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
NC := \033[0m

# =============================================================================
# âš¡ COMANDOS RÃPIDOS (aliases Ãºtiles)
# =============================================================================

.PHONY: prod
prod: ## Ver estado de producciÃ³n (alias rÃ¡pido)
	@$(MAKE) -f Makefile.production prod-status

.PHONY: dev
dev: ## Ver estado de desarrollo (alias rÃ¡pido)
	@$(MAKE) -f Makefile.development dev-status

.PHONY: logs
logs: ## Ver logs de producciÃ³n (Ãºltimas 50 lÃ­neas)
	@$(MAKE) -f Makefile.multi-env logs ENV=production

.PHONY: restart
restart: ## Reiniciar producciÃ³n con confirmaciÃ³n
	@$(MAKE) -f Makefile.multi-env restart ENV=production

.PHONY: backup
backup: ## Backup rÃ¡pido de producciÃ³n
	@$(MAKE) -f Makefile.production prod-backup

.PHONY: st
st: ## Status ultra-rÃ¡pido de producciÃ³n
	@curl -s http://$(NAS_HOST):3003/status | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"Status: {d['status']}\")" || echo "$(RED)âœ— Offline$(NC)"

.PHONY: db
db: ## Conectar a BD producciÃ³n
	@$(MAKE) -f Makefile.multi-env db-shell ENV=production

.PHONY: fix
fix: ## Aplicar fix de schema financiero en producciÃ³n
	@echo "$(YELLOW)ğŸ”§ Aplicando fix rÃ¡pido...$(NC)"
	@sshpass -e ssh $(NAS_USER)@$(NAS_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec ai-postgres psql -U ai_user -d ai_service -c 'CREATE TABLE IF NOT EXISTS financial.account_insights (id UUID PRIMARY KEY DEFAULT gen_random_uuid());'"
	@$(MAKE) restart

# =============================================================================
# ğŸš¨ COMANDOS DE EMERGENCIA
# =============================================================================

.PHONY: prod-emergency-stop
prod-emergency-stop: ## ğŸš¨ DETENER TODO en producciÃ³n INMEDIATAMENTE
	@echo "$(RED)ğŸš¨ DETENIENDO TODOS LOS SERVICIOS DE PRODUCCIÃ“N$(NC)"
	@sshpass -e ssh $(NAS_USER)@$(NAS_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker stop ai-service ai-postgres ai-redis ai-watchtower || true"
	@echo "$(RED)â›” SERVICIOS DETENIDOS$(NC)"

.PHONY: prod-emergency-restore
prod-emergency-restore: ## ğŸš¨ Restaurar Ãºltimo backup bueno conocido
	@echo "$(RED)ğŸš¨ RESTAURACIÃ“N DE EMERGENCIA$(NC)"
	@echo "$(YELLOW)Buscando Ãºltimo backup...$(NC)"
	@LAST_BACKUP=$$(sshpass -e ssh $(NAS_USER)@$(NAS_HOST) "ls -t $(NAS_PATH)/backups/*.sql.gz 2>/dev/null | head -1 | xargs basename" || echo ""); \
	if [ -z "$$LAST_BACKUP" ]; then \
		echo "$(RED)âœ— No se encontraron backups$(NC)"; \
		exit 1; \
	else \
		echo "$(BLUE)Ãšltimo backup: $$LAST_BACKUP$(NC)"; \
		echo "$(YELLOW)Restaurando...$(NC)"; \
		$(MAKE) -f Makefile.production prod-restore FILE=$$LAST_BACKUP; \
	fi

.PHONY: prod-rollback
prod-rollback: ## ğŸš¨ Rollback completo (detener, restaurar backup, reiniciar)
	@echo "$(RED)ğŸš¨ INICIANDO ROLLBACK COMPLETO$(NC)"
	@echo "$(YELLOW)Esto detendrÃ¡ servicios, restaurarÃ¡ el Ãºltimo backup y reiniciarÃ¡ todo$(NC)"
	@echo "$(RED)Â¿Continuar? Escribe 'ROLLBACK' para confirmar:$(NC)"
	@read CONFIRM && [ "$$CONFIRM" = "ROLLBACK" ] || (echo "$(GREEN)Cancelado$(NC)" && exit 1)
	@$(MAKE) prod-emergency-stop
	@$(MAKE) prod-emergency-restore
	@echo "$(YELLOW)Reiniciando servicios...$(NC)"
	@sshpass -e ssh $(NAS_USER)@$(NAS_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker start ai-postgres ai-redis ai-service"
	@sleep 10
	@$(MAKE) -f Makefile.production prod-health

.PHONY: 911
911: ## ğŸš¨ EMERGENCIA: Mostrar comandos de rescate
	@echo "$(RED)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(RED)â•‘                    ğŸš¨ COMANDOS DE EMERGENCIA ğŸš¨               â•‘$(NC)"
	@echo "$(RED)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Si el servicio estÃ¡ caÃ­do:$(NC)"
	@echo "  make prod-emergency-stop    # Detener todo"
	@echo "  make prod-health           # Ver quÃ© estÃ¡ mal"
	@echo "  make logs                  # Ver logs recientes"
	@echo "  make restart              # Reiniciar servicios"
	@echo ""
	@echo "$(YELLOW)Si hay errores de base de datos:$(NC)"
	@echo "  make db                   # Conectar a PostgreSQL"
	@echo "  make fix                  # Aplicar fix rÃ¡pido"
	@echo "  make prod-apply-schema    # Reaplicar schema completo"
	@echo ""
	@echo "$(YELLOW)Si necesitas hacer rollback:$(NC)"
	@echo "  make prod-backup-list     # Ver backups disponibles"
	@echo "  make prod-emergency-restore # Restaurar Ãºltimo backup"
	@echo "  make prod-rollback        # Rollback completo"
	@echo ""
	@echo "$(RED)Contacto de emergencia: $(NC)"
	@echo "  Telegram: @tu_usuario"
	@echo "  Email: tu@email.com"

# =============================================================================
# ğŸ¯ COMANDOS DE UN SOLO PROPÃ“SITO
# =============================================================================

.PHONY: fix-balance
fix-balance: ## Arreglar error de columna balance
	@echo "$(YELLOW)ğŸ”§ Arreglando error de balance...$(NC)"
	@sshpass -e ssh $(NAS_USER)@$(NAS_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec ai-postgres psql -U ai_user -d ai_service -c 'ALTER TABLE financial.accounts ADD COLUMN IF NOT EXISTS balance NUMERIC(20,8) DEFAULT 0;'"
	@$(MAKE) restart

.PHONY: create-db-only
create-db-only: ## Solo crear base de datos si no existe
	@sshpass -e ssh $(NAS_USER)@$(NAS_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec ai-postgres psql -U ai_user -d template1 -c 'CREATE DATABASE ai_service;' || echo 'Database already exists'"

.PHONY: check-all
check-all: ## VerificaciÃ³n completa del sistema
	@echo "$(BLUE)ğŸ” VerificaciÃ³n completa del sistema$(NC)"
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@$(MAKE) st
	@$(MAKE) -f Makefile.production prod-check-containers --no-print-directory | head -5
	@$(MAKE) -f Makefile.production prod-check-db --no-print-directory

# =============================================================================
# Ayuda
# =============================================================================

.PHONY: help
help: ## Mostrar comandos rÃ¡pidos y de emergencia
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘              âš¡ COMANDOS RÃPIDOS Y EMERGENCIA                 â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Comandos rÃ¡pidos:$(NC)"
	@grep -E '^[a-z]+:.*?## [^ğŸš¨].*$$' Makefile.quick | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(RED)Comandos de emergencia:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸš¨.*$$' Makefile.quick | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(RED)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Tip: usa 'make 911' para ver guÃ­a de emergencia$(NC)"

.PHONY: help-all
help-all: ## Ver TODOS los comandos disponibles
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘                  TODOS LOS COMANDOS DISPONIBLES               â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(MAKE) -f Makefile.quick help
	@echo ""
	@$(MAKE) -f Makefile.production help
	@echo ""
	@$(MAKE) -f Makefile.development help
	@echo ""
	@$(MAKE) -f Makefile.multi-env help
	@echo ""
	@$(MAKE) -f Makefile.compare help

.DEFAULT_GOAL := help