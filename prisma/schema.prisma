generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/client"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["financial", "public", "tagging", "trading"]
}

model accounts {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  account_id        String      @unique @db.VarChar(255)
  name              String      @db.VarChar(255)
  type              String      @db.VarChar(50)
  currency_id       String?     @db.Uuid
  balance           Decimal?    @default(0) @db.Decimal(20, 8)
  available_balance Decimal?    @default(0) @db.Decimal(20, 8)
  institution       String?     @db.VarChar(255)
  institution_id    String?     @db.VarChar(255)
  requisition_id    String?     @db.VarChar(255)
  iban              String?     @db.VarChar(255)
  wallet_address    String?     @db.VarChar(255)
  chain_id          String?     @db.VarChar(50)
  exchange_name     String?     @db.VarChar(100)
  metadata          Json?       @default("{}")
  is_active         Boolean?    @default(true)
  last_sync         DateTime?   @db.Timestamptz(6)
  created_at        DateTime?   @default(now()) @db.Timestamptz(6)
  updated_at        DateTime?   @default(now()) @db.Timestamptz(6)
  currencies        currencies? @relation(fields: [currency_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([institution_id], map: "idx_accounts_institution_id")
  @@schema("financial")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model categories {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                        String                        @unique @db.VarChar(100)
  type                        String?                       @db.VarChar(20)
  parent_id                   String?                       @db.Uuid
  color                       String?                       @db.VarChar(7)
  icon                        String?                       @db.VarChar(50)
  is_active                   Boolean?                      @default(true)
  created_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  categories                  categories?                   @relation("categoriesTocategories", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_categories            categories[]                  @relation("categoriesTocategories")
  transaction_categorizations transaction_categorizations[]

  @@schema("financial")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model client_transaction_links {
  id                 String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transaction_id     String?       @unique @db.Uuid
  client_id          String        @db.Uuid
  match_type         String        @db.VarChar(20)
  match_confidence   Decimal?      @default(1.00) @db.Decimal(3, 2)
  matched_by         String?       @db.VarChar(255)
  matched_at         DateTime?     @default(now()) @db.Timestamptz(6)
  match_criteria     Json?
  is_manual_override Boolean?      @default(false)
  previous_link_id   String?       @db.Uuid
  override_reason    String?
  notes              String?
  created_at         DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?     @default(now()) @db.Timestamptz(6)
  transactions       transactions? @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([client_id], map: "idx_client_transaction_links_client_id")
  @@index([match_type], map: "idx_client_transaction_links_match_type")
  @@index([transaction_id], map: "idx_client_transaction_links_transaction_id")
  @@schema("financial")
}

model Client {
  id                   String    @id @default(uuid()) @db.VarChar(255)
  name                 String    @db.VarChar(255)
  businessName         String?   @map("business_name") @db.VarChar(255)
  taxId                String    @map("tax_id") @db.VarChar(100)
  taxIdType            String    @default("OTHER") @map("tax_id_type") @db.VarChar(20)
  email                String    @db.VarChar(255)
  phone                String?   @db.VarChar(50)
  address              Json?
  clientType           String    @default("business") @map("client_type") @db.VarChar(20)
  currency             String    @default("EUR") @db.VarChar(10)
  language             String    @default("es") @db.VarChar(10)
  timezone             String?   @db.VarChar(50)
  paymentTerms         Int       @default(30) @map("payment_terms")
  paymentMethod        String?   @map("payment_method") @db.VarChar(20)
  bankAccount          String?   @map("bank_account") @db.VarChar(255)
  creditLimit          Decimal?  @default(0) @map("credit_limit") @db.Decimal(15, 2)
  status               String    @default("active") @db.VarChar(20)
  totalRevenue         Decimal   @default(0) @map("total_revenue") @db.Decimal(15, 2)
  totalInvoices        Int       @default(0) @map("total_invoices")
  outstandingBalance   Decimal   @default(0) @map("outstanding_balance") @db.Decimal(15, 2)
  lastInvoiceDate      DateTime? @map("last_invoice_date") @db.Timestamp(6)
  averageInvoiceAmount Decimal?  @map("average_invoice_amount") @db.Decimal(15, 2)
  customFields         Json?     @default("{}") @map("custom_fields")
  tags                 String[]  @default([])
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt            DateTime  @default(now()) @map("updated_at") @db.Timestamp(6)
  createdBy            String?   @map("created_by") @db.VarChar(255)
  lastContactDate      DateTime? @map("last_contact_date") @db.Timestamp(6)
  userId               String    @map("user_id") @db.Uuid
  user                 User      @relation(fields: [userId], references: [id])
  invoices             Invoice[]

  @@index([email], map: "idx_clients_email")
  @@index([status], map: "idx_clients_status")
  @@index([taxId], map: "idx_clients_tax_id")
  @@map("clients")
  @@schema("financial")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model currencies {
  id                                                    String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                                                  String         @unique @db.VarChar(10)
  name                                                  String         @db.VarChar(100)
  type                                                  String         @db.VarChar(20)
  decimals                                              Int?           @default(2)
  symbol                                                String?        @db.VarChar(10)
  is_active                                             Boolean?       @default(true)
  created_at                                            DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at                                            DateTime?      @default(now()) @db.Timestamptz(6)
  accounts                                              accounts[]
  transactions_transactions_currency_idTocurrencies     transactions[] @relation("transactions_currency_idTocurrencies")
  transactions_transactions_fee_currency_idTocurrencies transactions[] @relation("transactions_fee_currency_idTocurrencies")

  @@schema("financial")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model integration_configs {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String?  @db.Uuid
  integration_type String   @db.VarChar(50)
  config_key       String   @db.VarChar(100)
  config_value     String
  is_encrypted     Boolean  @default(true)
  is_global        Boolean  @default(false)
  description      String?
  metadata         Json?    @default("{}")
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @db.Timestamptz(6)
  User             User?    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([integration_type], map: "idx_integration_configs_type")
  @@schema("financial")
}

model invoice_sequences {
  id             Int      @id @default(autoincrement())
  prefix         String   @db.VarChar(20)
  current_number Int      @default(0)
  year           Int?
  format         String   @default("PREFIX-YYYY-0000") @db.VarChar(50)
  created_at     DateTime @default(now()) @db.Timestamp(6)
  updated_at     DateTime @default(now()) @db.Timestamp(6)

  @@unique([prefix, year], map: "unique_sequence_prefix_year")
  @@schema("financial")
}

model Invoice {
  id                    String    @id @default(uuid()) @db.VarChar(255)
  invoiceNumber         String    @unique @map("invoice_number") @db.VarChar(50)
  clientId              String?   @map("client_id") @db.VarChar(255)
  clientName            String    @map("client_name") @db.VarChar(255)
  clientTaxId           String    @map("client_tax_id") @db.VarChar(100)
  clientAddress         Json?     @map("client_address")
  type                  String    @default("invoice") @db.VarChar(20)
  status                String    @default("draft") @db.VarChar(20)
  issueDate             DateTime  @default(dbgenerated("CURRENT_DATE")) @map("issue_date") @db.Date
  dueDate               DateTime  @map("due_date") @db.Date
  paidDate              DateTime? @map("paid_date") @db.Date
  serviceStartDate      DateTime? @map("service_start_date") @db.Date
  serviceEndDate        DateTime? @map("service_end_date") @db.Date
  currency              String    @default("EUR") @db.VarChar(10)
  exchangeRate          Decimal?  @map("exchange_rate") @db.Decimal(10, 6)
  items                 Json      @default("[]")
  subtotal              Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount             Decimal   @default(0) @map("tax_amount") @db.Decimal(15, 2)
  taxRate               Decimal   @default(21) @map("tax_rate") @db.Decimal(5, 2)
  taxType               String    @default("IVA") @map("tax_type") @db.VarChar(10)
  discount              Decimal?  @db.Decimal(15, 2)
  discountType          String?   @map("discount_type") @db.VarChar(10)
  total                 Decimal   @default(0) @db.Decimal(15, 2)
  paymentMethod         String?   @map("payment_method") @db.VarChar(20)
  paymentTerms          Int       @default(30) @map("payment_terms")
  bankAccount           String?   @map("bank_account") @db.VarChar(255)
  paymentReference      String?   @map("payment_reference") @db.VarChar(255)
  relatedDocuments      Json?     @default("[]") @map("related_documents")
  relatedTransactionIds String[]  @default([]) @map("related_transaction_ids")
  notes                 String?
  termsAndConditions    String?   @map("terms_and_conditions")
  customFields          Json?     @default("{}") @map("custom_fields")
  tags                  String[]  @default([])
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime  @default(now()) @map("updated_at") @db.Timestamp(6)
  sentAt                DateTime? @map("sent_at") @db.Timestamp(6)
  viewedAt              DateTime? @map("viewed_at") @db.Timestamp(6)
  createdBy             String?   @map("created_by") @db.VarChar(255)
  attachments           Json?     @default("[]")
  pdfUrl                String?   @map("pdf_url") @db.VarChar(500)
  isDeductible          Boolean?  @default(false) @map("is_deductible")
  deductibleCategory    String?   @map("deductible_category") @db.VarChar(100)
  deductiblePercentage  Decimal?  @map("deductible_percentage") @db.Decimal(5, 2)
  userId                String    @map("user_id") @db.Uuid
  templateId            String?   @map("template_id") @db.Uuid
  client                Client?   @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user                  User      @relation(fields: [userId], references: [id])
  invoiceAttachments    InvoiceAttachment[]

  @@index([clientId], map: "idx_invoices_client_id")
  @@index([invoiceNumber], map: "idx_invoices_invoice_number")
  @@index([issueDate(sort: Desc)], map: "idx_invoices_issue_date")
  @@index([status], map: "idx_invoices_status")
  @@map("invoices")
  @@schema("financial")
}

model InvoiceAttachment {
  id          String   @id @default(uuid()) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid
  fileName    String   @map("file_name") @db.VarChar(255)
  filePath    String   @map("file_path")
  fileSize    BigInt   @map("file_size")
  fileType    String   @map("file_type") @db.VarChar(100)
  description String?
  uploadedBy  String   @map("uploaded_by") @db.VarChar(255)
  uploadedAt  DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  isDeleted   Boolean  @default(false) @map("is_deleted")
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy   String?  @map("deleted_by") @db.VarChar(255)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([invoiceId], map: "idx_invoice_attachments_invoice_id")
  @@map("invoice_attachments")
  @@schema("financial")
}

model InvoiceTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  name         String   @db.VarChar(255)
  description  String?
  isDefault    Boolean  @default(false) @map("is_default")
  templateType String   @default("invoice") @map("template_type") @db.VarChar(50)
  htmlContent  String   @map("html_content")
  variables    Json     @default("[]")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @default(now()) @map("updated_at") @db.Timestamp(6)
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_invoice_templates_user_id")
  @@index([templateType], map: "idx_invoice_templates_type")
  @@index([isDefault], map: "idx_invoice_templates_default")
  @@map("invoice_templates")
  @@schema("financial")
}

model transaction_categorizations {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transaction_id String?       @unique @db.Uuid
  category_id    String?       @db.Uuid
  confidence     Decimal?      @default(1.00) @db.Decimal(3, 2)
  method         String?       @default("manual") @db.VarChar(50)
  created_at     DateTime?     @default(now()) @db.Timestamptz(6)
  ai_tag_id      String?       @db.Uuid
  user_confirmed Boolean?      @default(false)
  categories     categories?   @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transactions   transactions? @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category_id], map: "idx_transaction_categorizations_category_id")
  @@index([transaction_id], map: "idx_transaction_categorizations_transaction_id")
  @@schema("financial")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaction_matching_patterns {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id       String    @db.Uuid
  pattern_type    String    @db.VarChar(20)
  pattern         String    @db.VarChar(500)
  confidence      Decimal?  @default(0.80) @db.Decimal(3, 2)
  amount_min      Decimal?  @db.Decimal(20, 8)
  amount_max      Decimal?  @db.Decimal(20, 8)
  day_of_month    Int?
  frequency       String?   @db.VarChar(20)
  is_active       Boolean?  @default(true)
  match_count     Int?      @default(0)
  last_matched_at DateTime? @db.Timestamptz(6)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([is_active], map: "idx_transaction_matching_patterns_active")
  @@index([client_id], map: "idx_transaction_matching_patterns_client_id")
  @@index([pattern_type], map: "idx_transaction_matching_patterns_pattern_type")
  @@schema("financial")
}

model transactions {
  id                                                  String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transaction_id                                      String                       @unique @db.VarChar(255)
  account_id                                          String                       @db.VarChar(255)
  amount                                              Decimal                      @db.Decimal(20, 8)
  currency_id                                         String?                      @db.Uuid
  type                                                String                       @db.VarChar(50)
  status                                              String?                      @default("confirmed") @db.VarChar(50)
  description                                         String?
  reference                                           String?                      @db.VarChar(255)
  counterparty_name                                   String?                      @db.VarChar(255)
  date                                                DateTime                     @db.Date
  created_at                                          DateTime?                    @default(now()) @db.Timestamptz(6)
  updated_at                                          DateTime?                    @default(now()) @db.Timestamptz(6)
  metadata                                            Json?                        @default("{}")
  tags                                                String[]
  fee_amount                                          Decimal?                     @db.Decimal(20, 8)
  fee_currency_id                                     String?                      @db.Uuid
  gocardless_data                                     Json?
  transaction_hash                                    String?                      @db.VarChar(255)
  block_number                                        Int?
  gas_used                                            String?                      @db.VarChar(255)
  gas_price                                           String?                      @db.VarChar(255)
  from_address                                        String?                      @db.VarChar(255)
  to_address                                          String?                      @db.VarChar(255)
  counterparty_account                                String?                      @db.VarChar(255)
  client_transaction_links                            client_transaction_links?
  transaction_categorizations                         transaction_categorizations?
  currencies_transactions_currency_idTocurrencies     currencies?                  @relation("transactions_currency_idTocurrencies", fields: [currency_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  currencies_transactions_fee_currency_idTocurrencies currencies?                  @relation("transactions_fee_currency_idTocurrencies", fields: [fee_currency_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([account_id], map: "idx_transactions_account_id")
  @@index([counterparty_name], map: "idx_transactions_counterparty")
  @@index([date], map: "idx_transactions_date")
  @@index([status], map: "idx_transactions_status")
  @@index([transaction_hash], map: "idx_transactions_transaction_hash")
  @@schema("financial")
}

model executions {
  id                String     @id @db.VarChar(36)
  workflow_id       String?    @db.VarChar(36)
  status            String     @db.VarChar(20)
  start_time        DateTime?  @default(now()) @db.Timestamptz(6)
  end_time          DateTime?  @db.Timestamptz(6)
  input_data        Json?
  output_data       Json?
  error_message     String?
  execution_time_ms Int?
  workflows         workflows? @relation(fields: [workflow_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([start_time], map: "idx_executions_start_time")
  @@index([status], map: "idx_executions_status")
  @@index([workflow_id], map: "idx_executions_workflow_id")
  @@schema("public")
}

model login_attempts {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @db.VarChar(255)
  ip_address   String    @db.Inet
  success      Boolean
  attempted_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([email, attempted_at], map: "idx_login_attempts_email")
  @@index([ip_address, attempted_at], map: "idx_login_attempts_ip")
  @@schema("public")
}

model metrics {
  id           Int       @id @default(autoincrement())
  metric_name  String    @db.VarChar(100)
  metric_value Decimal   @db.Decimal
  metric_type  String    @db.VarChar(50)
  tags         Json?
  timestamp    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([metric_name], map: "idx_metrics_name")
  @@index([timestamp], map: "idx_metrics_timestamp")
  @@schema("public")
}

model refresh_tokens {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  token_hash String    @db.VarChar(255)
  expires_at DateTime  @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  revoked_at DateTime? @db.Timestamptz(6)
  User       User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, token_hash], map: "unique_active_token")
  @@index([expires_at], map: "idx_refresh_tokens_expires_at")
  @@index([user_id], map: "idx_refresh_tokens_user_id")
  @@schema("public")
}

model schema_migrations {
  version     String    @id @db.VarChar(255)
  applied_at  DateTime? @default(now()) @db.Timestamptz(6)
  checksum    String?   @db.VarChar(64)
  description String?

  @@schema("public")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model security_logs {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_type String    @db.VarChar(100)
  user_id    String?   @db.Uuid
  email      String?   @db.VarChar(255)
  ip_address String    @db.Inet
  user_agent String?
  details    Json?
  success    Boolean
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  User       User?     @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_security_logs_created_at")
  @@index([email, created_at], map: "idx_security_logs_email")
  @@index([event_type, created_at], map: "idx_security_logs_event_type")
  @@index([ip_address, created_at], map: "idx_security_logs_ip")
  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model User {
  id                  String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email               String                 @unique @db.VarChar(255)
  password_hash       String                 @db.VarChar(255)
  full_name           String?                @db.VarChar(255)
  role                String?                @default("user") @db.VarChar(50)
  is_active           Boolean?               @default(true)
  last_login          DateTime?              @db.Timestamptz(6)
  created_at          DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?              @default(now()) @db.Timestamptz(6)
  clients             Client[]
  integration_configs integration_configs[]
  invoiceTemplates    InvoiceTemplate[]
  invoices            Invoice[]
  refresh_tokens      refresh_tokens[]
  security_logs       security_logs[]
  payments            Payment[]
  marketplaceListings StrategyMarketplace[]
  reviews             StrategyReview[]
  subscriptions       StrategySubscription[]
  alerts              Alert[]
  orders              Order[]

  @@index([email], map: "idx_users_email")
  @@map("users")
  @@schema("public")
}

model workflows {
  id            String       @id @db.VarChar(36)
  name          String       @db.VarChar(255)
  description   String?
  active        Boolean?     @default(false)
  workflow_data Json
  version       Int?         @default(1)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?    @default(now()) @db.Timestamptz(6)
  created_by    String?      @db.VarChar(255)
  tags          String[]
  executions    executions[]

  @@index([active], map: "idx_workflows_active")
  @@index([created_at], map: "idx_workflows_created_at")
  @@index([name], map: "idx_workflows_name")
  @@schema("public")
}

model Trade {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  positionId       String?  @map("position_id") @db.Uuid
  userId           String?  @map("user_id") @db.Uuid
  strategyId       String?  @map("strategy_id") @db.Uuid
  exchange         String   @db.VarChar(50)
  symbol           String   @db.VarChar(50)
  side             String   @db.VarChar(10)
  type             String   @default("market") @db.VarChar(20)
  quantity         Decimal  @db.Decimal(20, 8)
  price            Decimal  @db.Decimal(20, 8)
  fee              Decimal? @default(0) @db.Decimal(20, 8)
  fee_currency     String?  @db.VarChar(10)
  exchangeOrderId  String?  @map("exchange_order_id") @db.VarChar(255)
  status           String   @default("executed") @db.VarChar(20)
  ai_analysis      Json?
  confidence_score Decimal? @db.Decimal(5, 4)
  executedAt       DateTime @default(now()) @map("executed_at") @db.Timestamptz(6)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  metadata         Json?    @default("{}")
  strategy         Strategy? @relation(fields: [strategyId], references: [id])

  @@map("trades")
  @@schema("trading")
}

model Strategy {
  id               String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String?               @map("user_id") @db.Uuid
  name             String                @db.VarChar(100)
  type             String                @db.VarChar(50)
  status           String                @default("inactive") @db.VarChar(20)
  parameters       Json                  @default("{}")
  risk_parameters  Json?                 @default("{}")
  total_trades     Int?                  @default(0)
  winning_trades   Int?                  @default(0)
  losing_trades    Int?                  @default(0)
  total_pnl        Decimal?              @default(0) @db.Decimal(20, 8)
  sharpe_ratio     Decimal?              @db.Decimal(10, 4)
  max_drawdown     Decimal?              @db.Decimal(10, 4)
  win_rate         Decimal?              @db.Decimal(5, 4)
  is_paper_trading Boolean?              @default(true)
  isActive         Boolean?              @default(false) @map("is_active")
  last_execution   DateTime?             @db.Timestamptz(6)
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  metadata         Json?                 @default("{}")
  marketplace      StrategyMarketplace[]
  trades           Trade[]
  positions        Position[]
  alerts           Alert[]
  strategyTradingPairs StrategyTradingPair[]
  orders           Order[]

  @@index([userId], map: "idx_trading_strategies_user")
  @@map("strategies")
  @@schema("trading")
}

model Position {
  id            String    @id @default(uuid())
  userId        String    @map("user_id") @db.Uuid
  exchange      String    @db.VarChar(50)
  symbol        String    @db.VarChar(50)
  side          String    @db.VarChar(10)
  status        String    @default("open") @db.VarChar(20)
  quantity      Decimal   @db.Decimal(20, 8)
  realizedPnl   Decimal?  @default(0) @map("realized_pnl") @db.Decimal(20, 8)
  unrealizedPnl Decimal?  @default(0) @map("unrealized_pnl") @db.Decimal(20, 8)
  fees          Decimal?  @default(0) @db.Decimal(20, 8)
  strategyId    String?   @map("strategy_id") @db.Uuid
  openedAt      DateTime  @default(now()) @map("opened_at") @db.Timestamptz(6)
  closedAt      DateTime? @map("closed_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  metadata      Json?     @default("{}")
  avgEntryPrice Decimal   @map("avg_entry_price") @db.Decimal(20, 8)
  avgExitPrice  Decimal?  @map("avg_exit_price") @db.Decimal(20, 8)
  exchangeId    String?
  tradingPairId String?
  strategy      Strategy? @relation(fields: [strategyId], references: [id])

  @@index([strategyId], map: "idx_trading_positions_strategy")
  @@index([userId, status], map: "idx_trading_positions_user_status")
  @@map("positions")
  @@schema("trading")
}

model StrategyMarketplace {
  id               String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  strategyId       String                 @map("strategy_id") @db.Uuid
  userId           String                 @map("user_id") @db.Uuid
  name             String                 @db.VarChar(255)
  description      String?
  price            Decimal                @db.Decimal(10, 2)
  subscriptionType String                 @map("subscription_type") @db.VarChar(20)
  performanceData  Json                   @default("{}") @map("performance_data")
  isVerified       Boolean                @default(false) @map("is_verified")
  rating           Decimal?               @db.Decimal(3, 2)
  totalSubscribers Int                    @default(0) @map("total_subscribers")
  totalRevenue     Decimal                @default(0) @map("total_revenue") @db.Decimal(20, 2)
  status           String                 @default("active") @db.VarChar(20)
  tags             String[]               @default([])
  createdAt        DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  strategy         Strategy               @relation(fields: [strategyId], references: [id])
  user             User                   @relation(fields: [userId], references: [id])
  performance      StrategyPerformance[]
  reviews          StrategyReview[]
  subscriptions    StrategySubscription[]

  @@index([status, rating])
  @@index([userId])
  @@index([tags])
  @@map("strategy_marketplace")
  @@schema("trading")
}

model StrategySubscription {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String              @map("user_id") @db.Uuid
  marketplaceId   String              @map("marketplace_id") @db.Uuid
  tier            String              @db.VarChar(20)
  status          String              @default("active") @db.VarChar(20)
  startDate       DateTime            @default(now()) @map("start_date") @db.Timestamptz(6)
  expiresAt       DateTime            @map("expires_at") @db.Timestamptz(6)
  autoRenew       Boolean             @default(true) @map("auto_renew")
  paymentMethod   String?             @map("payment_method") @db.VarChar(50)
  amount          Decimal             @db.Decimal(10, 2)
  currency        String              @default("USD") @db.VarChar(3)
  lastPaymentDate DateTime?           @map("last_payment_date") @db.Timestamptz(6)
  nextPaymentDate DateTime?           @map("next_payment_date") @db.Timestamptz(6)
  metadata        Json?               @default("{}")
  createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  payments        Payment[]
  marketplace     StrategyMarketplace @relation(fields: [marketplaceId], references: [id])
  user            User                @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([expiresAt])
  @@index([marketplaceId])
  @@map("strategy_subscriptions")
  @@schema("trading")
}

model StrategyPerformance {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  marketplaceId  String              @map("marketplace_id") @db.Uuid
  period         String              @db.VarChar(20)
  startDate      DateTime            @map("start_date") @db.Timestamptz(6)
  endDate        DateTime            @map("end_date") @db.Timestamptz(6)
  totalTrades    Int                 @default(0) @map("total_trades")
  winRate        Decimal             @default(0) @map("win_rate") @db.Decimal(5, 2)
  totalPnl       Decimal             @default(0) @map("total_pnl") @db.Decimal(20, 2)
  sharpeRatio    Decimal?            @map("sharpe_ratio") @db.Decimal(10, 4)
  maxDrawdown    Decimal?            @map("max_drawdown") @db.Decimal(10, 4)
  avgTradeReturn Decimal?            @map("avg_trade_return") @db.Decimal(10, 4)
  metadata       Json?               @default("{}")
  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  marketplace    StrategyMarketplace @relation(fields: [marketplaceId], references: [id])

  @@index([marketplaceId, period])
  @@index([startDate, endDate])
  @@map("strategy_performance")
  @@schema("trading")
}

model StrategyReview {
  id            String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  marketplaceId String              @map("marketplace_id") @db.Uuid
  userId        String              @map("user_id") @db.Uuid
  rating        Int
  title         String?             @db.VarChar(255)
  comment       String?
  isVerified    Boolean             @default(false) @map("is_verified")
  helpful       Int                 @default(0)
  unhelpful     Int                 @default(0)
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  marketplace   StrategyMarketplace @relation(fields: [marketplaceId], references: [id])
  user          User                @relation(fields: [userId], references: [id])

  @@unique([marketplaceId, userId])
  @@index([marketplaceId, rating])
  @@map("strategy_reviews")
  @@schema("trading")
}

model Payment {
  id              String                @id @default(uuid())
  userId          String                @map("user_id") @db.Uuid
  subscriptionId  String?               @map("subscription_id") @db.Uuid
  amount          Decimal               @db.Decimal(10, 2)
  currency        String                @default("USD") @db.VarChar(3)
  status          String                @db.VarChar(20)
  paymentMethod   String                @map("payment_method") @db.VarChar(50)
  transactionId   String?               @map("transaction_id") @db.VarChar(255)
  paymentProvider String?               @map("payment_provider") @db.VarChar(50)
  description     String?
  metadata        Json?                 @default("{}")
  processedAt     DateTime?             @map("processed_at") @db.Timestamptz(6)
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  subscription    StrategySubscription? @relation(fields: [subscriptionId], references: [id])
  user            User                  @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([subscriptionId])
  @@index([transactionId])
  @@map("payments")
  @@schema("trading")
}

// Missing Trading Models
model Alert {
  id         String    @id @default(uuid())
  userId     String    @map("user_id") @db.Uuid
  strategyId String?   @map("strategy_id") @db.Uuid
  type       String    @db.VarChar(50) // price_alert, strategy_trigger, risk_warning, etc
  severity   String    @default("info") @db.VarChar(20) // info, warning, critical
  title      String    @db.VarChar(255)
  message    String
  data       Json?     @default("{}")
  isRead     Boolean   @default(false) @map("is_read")
  readAt     DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  user       User      @relation(fields: [userId], references: [id])
  strategy   Strategy? @relation(fields: [strategyId], references: [id])

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([type])
  @@index([severity])
  @@map("alerts")
  @@schema("trading")
}

model Exchange {
  id              String        @id @default(uuid())
  name            String        @unique @db.VarChar(50)
  displayName     String        @map("display_name") @db.VarChar(100)
  exchangeType    String        @map("exchange_type") @db.VarChar(20) // spot, futures, options
  isActive        Boolean       @default(true) @map("is_active")
  supportedAssets String[]      @default([]) @map("supported_assets")
  tradingFees     Json          @default("{}") @map("trading_fees") // maker/taker fees
  metadata        Json?         @default("{}")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  tradingPairs    TradingPair[]
  orders          Order[]
  marketData      MarketData[]

  @@index([name])
  @@index([isActive])
  @@map("exchanges")
  @@schema("trading")
}

model TradingPair {
  id                  String                @id @default(uuid())
  exchangeId          String                @map("exchange_id") @db.Uuid
  symbol              String                @db.VarChar(50)
  baseAsset           String                @map("base_asset") @db.VarChar(20)
  quoteAsset          String                @map("quote_asset") @db.VarChar(20)
  isActive            Boolean               @default(true) @map("is_active")
  minOrderSize        Decimal               @map("min_order_size") @db.Decimal(20, 8)
  maxOrderSize        Decimal?              @map("max_order_size") @db.Decimal(20, 8)
  tickSize            Decimal               @map("tick_size") @db.Decimal(20, 8)
  pricePrecision      Int                   @map("price_precision")
  quantityPrecision   Int                   @map("quantity_precision")
  metadata            Json?                 @default("{}")
  createdAt           DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  exchange            Exchange              @relation(fields: [exchangeId], references: [id])
  strategyTradingPair StrategyTradingPair[]
  orders              Order[]
  marketData          MarketData[]

  @@unique([exchangeId, symbol])
  @@index([exchangeId])
  @@index([symbol])
  @@index([baseAsset, quoteAsset])
  @@map("trading_pairs")
  @@schema("trading")
}

model StrategyTradingPair {
  id              String      @id @default(uuid())
  strategyId      String      @map("strategy_id") @db.Uuid
  tradingPairId   String      @map("trading_pair_id") @db.Uuid
  isActive        Boolean     @default(true) @map("is_active")
  allocation      Decimal     @db.Decimal(5, 4) // Percentage allocation
  maxPositionSize Decimal?    @map("max_position_size") @db.Decimal(20, 8)
  metadata        Json?       @default("{}")
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  strategy        Strategy    @relation(fields: [strategyId], references: [id])
  tradingPair     TradingPair @relation(fields: [tradingPairId], references: [id])

  @@unique([strategyId, tradingPairId])
  @@index([strategyId])
  @@index([tradingPairId])
  @@map("strategy_trading_pairs")
  @@schema("trading")
}

model Order {
  id                String       @id @default(uuid())
  userId            String?      @map("user_id") @db.Uuid
  strategyId        String?      @map("strategy_id") @db.Uuid
  exchangeId        String       @map("exchange_id") @db.Uuid
  tradingPairId     String       @map("trading_pair_id") @db.Uuid
  exchangeOrderId   String?      @map("exchange_order_id") @db.VarChar(255)
  clientOrderId     String?      @map("client_order_id") @db.VarChar(255)
  type              String       @db.VarChar(20) // market, limit, stop, stop_limit
  side              String       @db.VarChar(10) // buy, sell
  status            String       @default("pending") @db.VarChar(20) // pending, open, filled, cancelled, rejected
  price             Decimal?     @db.Decimal(20, 8)
  stopPrice         Decimal?     @map("stop_price") @db.Decimal(20, 8)
  quantity          Decimal      @db.Decimal(20, 8)
  filledQuantity    Decimal      @default(0) @map("filled_quantity") @db.Decimal(20, 8)
  avgFillPrice      Decimal?     @map("avg_fill_price") @db.Decimal(20, 8)
  fee               Decimal?     @default(0) @db.Decimal(20, 8)
  feeCurrency       String?      @map("fee_currency") @db.VarChar(10)
  timeInForce       String?      @map("time_in_force") @db.VarChar(10) // GTC, IOC, FOK
  postOnly          Boolean      @default(false) @map("post_only")
  reduceOnly        Boolean      @default(false) @map("reduce_only")
  metadata          Json?        @default("{}")
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  filledAt          DateTime?    @map("filled_at") @db.Timestamptz(6)
  cancelledAt       DateTime?    @map("cancelled_at") @db.Timestamptz(6)
  user              User?        @relation(fields: [userId], references: [id])
  strategy          Strategy?    @relation(fields: [strategyId], references: [id])
  exchange          Exchange     @relation(fields: [exchangeId], references: [id])
  tradingPair       TradingPair  @relation(fields: [tradingPairId], references: [id])

  @@index([userId])
  @@index([strategyId])
  @@index([exchangeId])
  @@index([tradingPairId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
  @@schema("trading")
}

model MarketData {
  id            String      @id @default(uuid())
  exchangeId    String      @map("exchange_id") @db.Uuid
  tradingPairId String      @map("trading_pair_id") @db.Uuid
  timestamp     DateTime    @db.Timestamptz(6)
  open          Decimal     @db.Decimal(20, 8)
  high          Decimal     @db.Decimal(20, 8)
  low           Decimal     @db.Decimal(20, 8)
  close         Decimal     @db.Decimal(20, 8)
  volume        Decimal     @db.Decimal(20, 8)
  quoteVolume   Decimal?    @map("quote_volume") @db.Decimal(20, 8)
  trades        Int?
  timeframe     String      @db.VarChar(10) // 1m, 5m, 15m, 1h, 4h, 1d
  metadata      Json?       @default("{}")
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  exchange      Exchange    @relation(fields: [exchangeId], references: [id])
  tradingPair   TradingPair @relation(fields: [tradingPairId], references: [id])

  @@index([exchangeId, tradingPairId, timestamp])
  @@index([timestamp])
  @@map("market_data")
  @@schema("trading")
}

model UniversalTag {
  id             String    @id @default(uuid())
  code           String    @unique @db.VarChar(100)
  name           String    @db.VarChar(255)
  description    String?
  entityTypes    String[]  @map("entity_types")
  patterns       Json?
  rules          Json?
  confidence     Float     @default(0.5)
  embeddingModel String?   @map("embedding_model") @db.VarChar(50)
  path           String
  level          Int       @default(0)
  color          String?   @db.VarChar(7)
  icon           String?   @db.VarChar(50)
  isActive       Boolean   @default(true) @map("is_active")
  isSystem       Boolean   @default(false) @map("is_system")
  metadata       Json?
  usageCount     Int       @default(0) @map("usage_count")
  successRate    Float     @default(0.0) @map("success_rate")
  lastUsed       DateTime? @map("last_used") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  parentId       String?   @map("parent_id") @db.Uuid

  @@index([code])
  @@index([path])
  @@index([isActive])
  @@map("universal_tags")
  @@schema("tagging")
}

model EntityTag {
  id               String    @id @default(uuid())
  entityType       String    @map("entity_type") @db.VarChar(50)
  entityId         String    @map("entity_id") @db.VarChar(255)
  method           String    @db.VarChar(20)
  confidence       Float     @default(0.5)
  appliedBy        String?   @map("applied_by") @db.VarChar(255)
  aiProvider       String?   @map("ai_provider") @db.VarChar(50)
  aiModel          String?   @map("ai_model") @db.VarChar(100)
  aiResponse       Json?     @map("ai_response")
  aiReasoning      String?   @map("ai_reasoning")
  isVerified       Boolean   @default(false) @map("is_verified")
  verifiedBy       String?   @map("verified_by") @db.VarChar(255)
  verifiedAt       DateTime? @map("verified_at") @db.Timestamptz(6)
  feedback         String?
  isCorrect        Boolean?  @map("is_correct")
  sourceEntityType String?   @map("source_entity_type") @db.VarChar(50)
  sourceEntityId   String?   @map("source_entity_id") @db.VarChar(255)
  relationshipType String?   @map("relationship_type") @db.VarChar(50)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  tagId            String    @map("tag_id") @db.Uuid

  @@index([entityType, entityId])
  @@index([confidence])
  @@index([method])
  @@index([isVerified])
  @@index([createdAt])
  @@map("entity_tags")
  @@schema("tagging")
}

model TagPattern {
  id            String   @id @default(uuid())
  patternType   String   @map("pattern_type") @db.VarChar(20)
  pattern       Json
  weight        Float    @default(1.0)
  minConfidence Float    @default(0.5) @map("min_confidence")
  matchCount    Int      @default(0) @map("match_count")
  successCount  Int      @default(0) @map("success_count")
  accuracy      Float    @default(0.0)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tagId         String   @map("tag_id") @db.Uuid

  @@index([isActive])
  @@map("tag_patterns")
  @@schema("tagging")
}

model EntityRelationship {
  id               String   @id @default(uuid())
  sourceType       String   @map("source_type") @db.VarChar(50)
  sourceId         String   @map("source_id") @db.VarChar(255)
  targetType       String   @map("target_type") @db.VarChar(50)
  targetId         String   @map("target_id") @db.VarChar(255)
  relationshipType String   @map("relationship_type") @db.VarChar(50)
  confidence       Float
  discoveredBy     String   @map("discovered_by") @db.VarChar(20)
  metadata         Json?
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([sourceType, sourceId, targetType, targetId, relationshipType], map: "entity_relationships_source_type_source_id_target_type_tar_key")
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([relationshipType])
  @@map("entity_relationships")
  @@schema("tagging")
}

model TaggingAuditLog {
  id               String   @id @default(uuid())
  operation        String   @db.VarChar(50)
  entityType       String   @map("entity_type") @db.VarChar(50)
  entityId         String   @map("entity_id") @db.VarChar(255)
  previousTags     Json?    @map("previous_tags")
  newTags          Json?    @map("new_tags")
  changes          Json?
  method           String?  @db.VarChar(20)
  userId           String?  @map("user_id") @db.VarChar(255)
  userEmail        String?  @map("user_email") @db.VarChar(255)
  ipAddress        String?  @map("ip_address") @db.Inet
  userAgent        String?  @map("user_agent")
  success          Boolean
  errorMessage     String?  @map("error_message")
  processingTimeMs Int?     @map("processing_time_ms")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  entityTagId      String?  @map("entity_tag_id") @db.Uuid

  @@index([entityType, entityId])
  @@index([operation])
  @@index([createdAt])
  @@index([userId])
  @@map("tagging_audit_log")
  @@schema("tagging")
}

model TagLearningFeedback {
  id               String    @id @default(uuid())
  entityType       String    @map("entity_type") @db.VarChar(50)
  entityId         String    @map("entity_id") @db.VarChar(255)
  isCorrect        Boolean   @map("is_correct")
  confidenceImpact Float?    @map("confidence_impact")
  userId           String    @map("user_id") @db.VarChar(255)
  userRole         String?   @map("user_role") @db.VarChar(50)
  feedbackText     String?   @map("feedback_text")
  isProcessed      Boolean   @default(false) @map("is_processed")
  processedAt      DateTime? @map("processed_at") @db.Timestamptz(6)
  appliedChanges   Json?     @map("applied_changes")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  entityTagId      String?   @map("entity_tag_id") @db.Uuid
  originalTagId    String?   @map("original_tag_id") @db.Uuid
  suggestedTagId   String?   @map("suggested_tag_id") @db.Uuid

  @@index([entityType, entityId])
  @@index([isProcessed])
  @@index([createdAt])
  @@map("tag_learning_feedback")
  @@schema("tagging")
}

model TagMetrics {
  id              String   @id @default(uuid())
  periodStart     DateTime @map("period_start") @db.Date
  periodEnd       DateTime @map("period_end") @db.Date
  periodType      String   @map("period_type") @db.VarChar(20)
  usageCount      Int      @default(0) @map("usage_count")
  uniqueEntities  Int      @default(0) @map("unique_entities")
  verifiedCount   Int      @default(0) @map("verified_count")
  correctCount    Int      @default(0) @map("correct_count")
  accuracyRate    Float?   @map("accuracy_rate")
  avgConfidence   Float?   @map("avg_confidence")
  avgProcessingMs Float?   @map("avg_processing_time_ms")
  aiCount         Int      @default(0) @map("ai_count")
  patternCount    Int      @default(0) @map("pattern_count")
  manualCount     Int      @default(0) @map("manual_count")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  tagId           String   @map("tag_id") @db.Uuid

  @@index([periodStart, periodType])
  @@map("tag_metrics")
  @@schema("tagging")
}

model TagAIModel {
  id               String   @id @default(uuid())
  provider         String   @db.VarChar(50)
  modelName        String   @map("model_name") @db.VarChar(100)
  modelVersion     String   @map("model_version") @db.VarChar(50)
  config           Json?
  minConfidence    Float    @default(0.7) @map("min_confidence")
  totalPredictions Int      @default(0) @map("total_predictions")
  successRate      Float    @default(0.0) @map("success_rate")
  avgLatencyMs     Float?   @map("avg_latency_ms")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tagId            String   @map("tag_id") @db.Uuid

  @@index([provider])
  @@index([isActive])
  @@map("tag_ai_models")
  @@schema("tagging")
}

model TagImportJob {
  id               String    @id @default(uuid())
  jobType          String    @map("job_type") @db.VarChar(20)
  status           String    @default("pending") @db.VarChar(20)
  config           Json
  totalRecords     Int?      @map("total_records")
  processedRecords Int       @default(0) @map("processed_records")
  successCount     Int       @default(0) @map("success_count")
  errorCount       Int       @default(0) @map("error_count")
  errors           Json?
  startedAt        DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt      DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy        String    @map("created_by") @db.VarChar(255)

  @@index([status])
  @@index([jobType])
  @@index([createdAt])
  @@map("tag_import_jobs")
  @@schema("tagging")
}

model BacktestResult {
  id             String   @id @default(uuid())
  strategyId     String   @map("strategy_id") @db.Uuid
  startDate      DateTime @map("start_date") @db.Timestamptz(6)
  endDate        DateTime @map("end_date") @db.Timestamptz(6)
  initialCapital Decimal  @map("initial_capital") @db.Decimal(20, 8)
  finalCapital   Decimal  @map("final_capital") @db.Decimal(20, 8)
  totalReturn    Decimal  @map("total_return") @db.Decimal(20, 8)
  totalTrades    Int      @map("total_trades")
  winningTrades  Int      @map("winning_trades")
  losingTrades   Int      @map("losing_trades")
  sharpeRatio    Decimal? @map("sharpe_ratio") @db.Decimal(10, 4)
  sortinoRatio   Decimal? @map("sortino_ratio") @db.Decimal(10, 4)
  maxDrawdown    Decimal  @map("max_drawdown") @db.Decimal(20, 8)
  winRate        Decimal  @map("win_rate") @db.Decimal(5, 4)
  profitFactor   Decimal? @map("profit_factor") @db.Decimal(10, 4)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt    DateTime @map("completed_at") @db.Timestamptz(6)
  metadata       Json?
  name           String   @db.VarChar(255)
  parameters     Json

  @@map("backtest_results")
  @@schema("trading")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model sync_logs {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  account_id             String?
  accounts_synced        Int       @default(0)
  transactions_synced    Int       @default(0)
  status                 String?
  synced_transactions    Int?      @default(0)
  message                String?
  operation_type         String?   @default("full")
  success                Boolean   @default(false)
  attempts               Int       @default(1)
  error                  String?
  sync_duration_ms       Int?
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  rate_limited_endpoints Json?
  rate_limit_resets      Json?

  @@index([account_id], map: "idx_sync_logs_account_id")
  @@index([created_at(sort: Desc)], map: "idx_sync_logs_created_at")
  @@index([operation_type], map: "idx_sync_logs_operation_type")
  @@index([success], map: "idx_sync_logs_success")
  @@schema("financial")
}

model invoice_numbering_sequences {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  series         String    @default("DEFAULT") @db.VarChar(50)
  prefix         String    @db.VarChar(20)
  current_number Int       @default(0)
  current_year   Int
  format         String    @db.VarChar(50)
  yearly_reset   Boolean   @default(true)
  last_used      DateTime? @db.Timestamptz(6)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  updated_at     DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([series, prefix, current_year])
  @@index([series], map: "idx_invoice_numbering_series")
  @@index([current_year], map: "idx_invoice_numbering_year")
  @@schema("public")
}

model memories {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        String    @db.VarChar(50)
  content     Json
  embedding   Float[]   @default([]) @db.Real
  metadata    Json?     @default("{}")
  connections String[]  @default([]) @db.Uuid
  user_id     String?   @db.Uuid
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at(sort: Desc)], map: "idx_memories_created_at")
  @@index([type], map: "idx_memories_type")
  @@index([user_id], map: "idx_memories_user_id")
  @@schema("public")
}

model stored_invoices {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoice_id     String    @db.VarChar(255)
  invoice_number String    @db.VarChar(100)
  file_name      String    @db.VarChar(255)
  file_path      String
  file_size      BigInt
  mime_type      String    @default("application/pdf") @db.VarChar(100)
  storage_type   String    @default("local") @db.VarChar(20)
  url            String?
  metadata       Json?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  expires_at     DateTime? @db.Timestamptz(6)

  @@unique([invoice_id, file_name])
  @@index([created_at], map: "idx_stored_invoices_created_at")
  @@index([expires_at], map: "idx_stored_invoices_expires_at")
  @@index([invoice_id], map: "idx_stored_invoices_invoice_id")
  @@index([invoice_number], map: "idx_stored_invoices_invoice_number")
  @@schema("public")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model config {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String?  @db.Uuid
  config_key   String   @db.VarChar(100)
  config_value Json
  description  String?
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  @@unique([user_id, config_key])
  @@schema("trading")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model market_data_cache {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exchange   String   @db.VarChar(50)
  symbol     String   @db.VarChar(50)
  timeframe  String   @db.VarChar(10)
  timestamp  DateTime @db.Timestamptz(6)
  open       Decimal  @db.Decimal(20, 8)
  high       Decimal  @db.Decimal(20, 8)
  low        Decimal  @db.Decimal(20, 8)
  close      Decimal  @db.Decimal(20, 8)
  volume     Decimal  @db.Decimal(20, 8)
  indicators Json?    @default("{}")
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([exchange, symbol, timeframe, timestamp])
  @@index([exchange, symbol, timeframe, timestamp(sort: Desc)], map: "idx_market_data_lookup")
  @@index([timestamp(sort: Desc)], map: "idx_market_data_timestamp")
  @@schema("trading")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model signals {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  strategy_id     String?   @db.Uuid
  exchange        String    @db.VarChar(50)
  symbol          String    @db.VarChar(50)
  action          String    @db.VarChar(20)
  strength        Decimal   @db.Decimal(5, 4)
  analysis        Json
  indicators_used Json?     @default("[]")
  is_executed     Boolean?  @default(false)
  position_id     String?   @db.Uuid
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  expires_at      DateTime? @db.Timestamptz(6)
  executed_at     DateTime? @db.Timestamptz(6)
  metadata        Json?     @default("{}")

  @@index([created_at(sort: Desc)], map: "idx_trading_signals_created")
  @@index([strategy_id], map: "idx_trading_signals_strategy")
  @@index([symbol], map: "idx_trading_signals_symbol")
  @@schema("trading")
}
