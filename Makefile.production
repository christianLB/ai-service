# Makefile.production - Comandos especÃ­ficos para producciÃ³n
# ADVERTENCIA: Estos comandos afectan PRODUCCIÃ“N. Usar con cuidado.

include .make.env

# Variables de producciÃ³n
PROD_HOST := 192.168.1.11
PROD_USER := k2600x
PROD_PATH := /volume1/docker/ai-service
PROD_DB := ai_service
PROD_DB_USER := ai_user
PROD_CONTAINER := ai-postgres
BACKUP_DIR := $(PROD_PATH)/backups

# SSH con autenticaciÃ³n
ifdef SSHPASS
    export SSHPASS
    SSH := sshpass -e ssh
    SCP := sshpass -e scp
else
    SSH := ssh
    SCP := scp
endif

# Colores
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m

# =============================================================================
# ğŸ”´ COMANDOS DE PRODUCCIÃ“N - Reset y Recovery
# =============================================================================

.PHONY: prod-reset-db
prod-reset-db: ## Reset completo de BD en PRODUCCIÃ“N (con confirmaciÃ³n)
	@echo "$(RED)âš ï¸  ADVERTENCIA: Esto ELIMINARÃ TODOS LOS DATOS en PRODUCCIÃ“N$(NC)"
	@echo "$(RED)Host: $(PROD_HOST)$(NC)"
	@echo "$(RED)Base de datos: $(PROD_DB)$(NC)"
	@echo "$(YELLOW)Â¿EstÃ¡s ABSOLUTAMENTE SEGURO? Escribe 'SI ELIMINAR TODO' para continuar:$(NC)"
	@read CONFIRM && [ "$$CONFIRM" = "SI ELIMINAR TODO" ] || (echo "$(GREEN)Cancelado$(NC)" && exit 1)
	@$(MAKE) prod-backup
	@echo "$(YELLOW)Ejecutando reset...$(NC)"
	@$(MAKE) prod-reset-db-force

.PHONY: prod-reset-db-force
prod-reset-db-force: ## Reset sin confirmaciÃ³n (solo para emergencias)
	@echo "$(RED)ğŸ”¥ RESET FORZADO EN PRODUCCIÃ“N$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker stop ai-service ai-postgres ai-redis || true"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S rm -rf $(PROD_PATH)/postgres-data/*"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker start ai-postgres"
	@sleep 10
	@$(MAKE) prod-create-db
	@$(MAKE) prod-apply-schema
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker start ai-redis ai-service"
	@sleep 10
	@$(MAKE) prod-health

.PHONY: prod-create-db
prod-create-db: ## Crear base de datos en producciÃ³n si no existe
	@echo "$(BLUE)ğŸ“Š Creando base de datos si no existe...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec $(PROD_CONTAINER) psql -U $(PROD_DB_USER) -d template1 -tc \"SELECT 1 FROM pg_database WHERE datname = '$(PROD_DB)'\" | grep -q 1 || echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec $(PROD_CONTAINER) psql -U $(PROD_DB_USER) -d template1 -c 'CREATE DATABASE $(PROD_DB);'"
	@echo "$(GREEN)âœ“ Base de datos verificada/creada$(NC)"

.PHONY: prod-apply-schema
prod-apply-schema: ## Aplicar schema completo en producciÃ³n
	@echo "$(BLUE)ğŸ“ Aplicando schema en producciÃ³n...$(NC)"
	@$(SCP) scripts/complete-production-schema.sql $(PROD_USER)@$(PROD_HOST):/tmp/
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec -i $(PROD_CONTAINER) psql -U $(PROD_DB_USER) -d $(PROD_DB) < /tmp/complete-production-schema.sql"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "rm /tmp/complete-production-schema.sql"
	@echo "$(GREEN)âœ“ Schema aplicado$(NC)"

.PHONY: prod-fix-permissions
prod-fix-permissions: ## Arreglar permisos de archivos en el NAS
	@echo "$(BLUE)ğŸ”§ Arreglando permisos...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S chmod -R 644 $(PROD_PATH)/config/*.sql"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S chown -R $(PROD_USER):users $(PROD_PATH)/config/"
	@echo "$(GREEN)âœ“ Permisos corregidos$(NC)"

# =============================================================================
# ğŸ”´ COMANDOS DE PRODUCCIÃ“N - Build y Deploy
# =============================================================================

.PHONY: prod-build-image
prod-build-image: ## ğŸ—ï¸ Construir imagen Docker de producciÃ³n
	@echo "$(BLUE)ğŸ—ï¸ Construyendo imagen de producciÃ³n...$(NC)"
	@echo "$(YELLOW)1. Compilando TypeScript...$(NC)"
	@npm run build
	@echo "$(YELLOW)2. Construyendo imagen Docker...$(NC)"
	@docker build -f Dockerfile -t ai-service:simple .
	@echo "$(YELLOW)3. Exportando imagen...$(NC)"
	@docker save ai-service:simple | gzip > ai-service-production.tar.gz
	@echo "$(GREEN)âœ“ Imagen creada: ai-service-production.tar.gz$(NC)"
	@ls -lh ai-service-production.tar.gz

.PHONY: prod-deploy-image
prod-deploy-image: ## Deploy imagen Docker a producciÃ³n con backup automÃ¡tico
	@echo "$(BLUE)ğŸ“¦ Desplegando imagen Docker a producciÃ³n...$(NC)"
	@if [ ! -f ai-service-production.tar.gz ]; then \
		echo "$(RED)Error: No se encuentra ai-service-production.tar.gz$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)ğŸ“¸ Creando backup pre-deploy...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd $(PROD_PATH) && ./scripts/emergency/pre-deploy-backup.sh remote"
	@echo "$(YELLOW)Copiando imagen al NAS...$(NC)"
	@$(SCP) ai-service-production.tar.gz $(PROD_USER)@$(PROD_HOST):/tmp/
	@echo "$(YELLOW)Cargando imagen en Docker...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd /tmp && echo '$(SUDO_PASS)' | sudo -S sh -c 'gunzip -c ai-service-production.tar.gz | /usr/local/bin/docker load'"
	@echo "$(GREEN)âœ“ Imagen ai-service:simple cargada$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "rm /tmp/ai-service-production.tar.gz"
	@echo "$(YELLOW)Reiniciando servicios...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd $(PROD_PATH) && echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker-compose up -d"
	@echo "$(GREEN)âœ“ Deploy completado$(NC)"
	@echo "$(YELLOW)ğŸ’¡ En caso de problemas: make prod-emergency-restore$(NC)"
	@sleep 5
	@$(MAKE) prod-health

.PHONY: prod-update-config
prod-update-config: ## Actualizar configuraciÃ³n de docker-compose en producciÃ³n con backup
	@echo "$(BLUE)ğŸ”§ Actualizando configuraciÃ³n en producciÃ³n...$(NC)"
	@echo "$(YELLOW)ğŸ“¸ Creando backup de configuraciÃ³n...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cp $(PROD_PATH)/docker-compose.yml $(PROD_PATH)/docker-compose.yml.backup-$(shell date +%Y%m%d_%H%M%S) 2>/dev/null || true"
	@$(SCP) docker-compose.production.yml $(PROD_USER)@$(PROD_HOST):$(PROD_PATH)/docker-compose.yml
	@echo "$(GREEN)âœ“ ConfiguraciÃ³n actualizada$(NC)"
	@echo "$(YELLOW)Creando directorios necesarios...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S mkdir -p $(PROD_PATH)/postgres $(PROD_PATH)/redis $(PROD_PATH)/logs $(PROD_PATH)/documents $(PROD_PATH)/config"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S chown -R $(PROD_USER):users $(PROD_PATH)/postgres $(PROD_PATH)/redis $(PROD_PATH)/logs $(PROD_PATH)/documents $(PROD_PATH)/config"
	@echo "$(YELLOW)Reiniciando servicios...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd $(PROD_PATH) && echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker-compose down --remove-orphans"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd $(PROD_PATH) && echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker-compose up -d"
	@echo "$(GREEN)âœ“ Servicios reiniciados$(NC)"
	@echo "$(YELLOW)ğŸ’¡ En caso de problemas: make prod-emergency-restore$(NC)"
	@sleep 5
	@echo "$(BLUE)ğŸ“‹ Revisando logs del servicio...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker logs ai-service --tail=20"

.PHONY: prod-logs
prod-logs: ## Ver logs del servicio AI
	@echo "$(BLUE)ğŸ“‹ Logs del servicio AI...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker logs ai-service --tail=50"

.PHONY: prod-ps
prod-ps: ## Ver todos los contenedores
	@echo "$(BLUE)ğŸ“‹ Contenedores en producciÃ³n...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker ps -a | grep -E 'ai-|CONTAINER'"

.PHONY: prod-start
prod-start: ## Iniciar el servicio AI
	@echo "$(BLUE)ğŸš€ Iniciando servicio AI...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker start ai-service"
	@echo "$(GREEN)âœ“ Servicio iniciado$(NC)"

.PHONY: prod-logs-full
prod-logs-full: ## Ver logs completos del servicio AI
	@echo "$(BLUE)ğŸ“‹ Logs completos del servicio AI...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker logs ai-service"

.PHONY: prod-logs-postgres
prod-logs-postgres: ## Ver logs de PostgreSQL
	@echo "$(BLUE)ğŸ“‹ Logs de PostgreSQL...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker logs ai-postgres --tail=30"

.PHONY: prod-reset-postgres
prod-reset-postgres: ## Limpiar y reinicializar PostgreSQL
	@echo "$(RED)âš ï¸  Limpiando datos de PostgreSQL (versiÃ³n incompatible)...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd $(PROD_PATH) && echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker-compose stop"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker rm ai-postgres || true"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S rm -rf $(PROD_PATH)/postgres"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S mkdir -p $(PROD_PATH)/postgres"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S chown -R $(PROD_USER):users $(PROD_PATH)/postgres"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S ls -la $(PROD_PATH)/postgres/"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "cd $(PROD_PATH) && echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker-compose up -d"
	@echo "$(GREEN)âœ“ PostgreSQL reinicializado$(NC)"

# =============================================================================
# ğŸ”´ COMANDOS DE PRODUCCIÃ“N - DiagnÃ³stico
# =============================================================================

.PHONY: prod-status
prod-status: ## Estado completo del sistema en producciÃ³n
	@echo "$(BLUE)ğŸ“Š ESTADO DE PRODUCCIÃ“N$(NC)"
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(BLUE)Servicio AI:$(NC)"
	@-curl -s http://$(PROD_HOST):3003/status | python3 -m json.tool | head -20
	@echo ""
	@echo "$(BLUE)Contenedores:$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | grep -E '(ai-|postgres|redis|watchtower)' || echo 'No hay contenedores AI corriendo'"
	@echo ""
	@echo "$(BLUE)Base de datos:$(NC)"
	@$(MAKE) -f Makefile.production prod-check-db --no-print-directory

.PHONY: prod-check-containers
prod-check-containers: ## Ver todos los contenedores en el NAS
	@echo "$(BLUE)ğŸ³ Contenedores en producciÃ³n:$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker ps -a --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}' | head -20"

.PHONY: prod-check-db
prod-check-db: ## Verificar BD y tablas en producciÃ³n
	@echo "$(BLUE)ğŸ—„ï¸  Verificando base de datos...$(NC)"
	@echo -n "ConexiÃ³n: "
	@if $(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec $(PROD_CONTAINER) pg_isready -U $(PROD_DB_USER) -d $(PROD_DB)" >/dev/null 2>&1; then \
		echo "$(GREEN)âœ“ OK$(NC)"; \
	else \
		echo "$(RED)âœ— ERROR$(NC)"; \
	fi
	@echo -n "Tablas financial: "
	@COUNT=$$($(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec $(PROD_CONTAINER) psql -U $(PROD_DB_USER) -d $(PROD_DB) -t -c \"SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'financial';\"" 2>/dev/null | tr -d ' '); \
	echo "$(GREEN)$$COUNT tablas$(NC)"

.PHONY: prod-health
prod-health: ## Health check completo de producciÃ³n
	@echo "$(BLUE)ğŸ¥ Health Check ProducciÃ³n$(NC)"
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@STATUS=$$(curl -s http://$(PROD_HOST):3003/status | python3 -c "import sys, json; d=json.load(sys.stdin); print(d.get('status', 'unknown'))" 2>/dev/null || echo "error"); \
	if [ "$$STATUS" = "healthy" ]; then \
		echo "Estado: $(GREEN)âœ“ $$STATUS$(NC)"; \
	elif [ "$$STATUS" = "degraded" ]; then \
		echo "Estado: $(YELLOW)âš  $$STATUS$(NC)"; \
	else \
		echo "Estado: $(RED)âœ— $$STATUS$(NC)"; \
	fi
	@echo -n "Dashboard: "
	@if curl -s http://$(PROD_HOST):3003/api/financial/dashboard/overview | grep -q '"success":true' 2>/dev/null; then \
		echo "$(GREEN)âœ“ Funcionando$(NC)"; \
	else \
		echo "$(RED)âœ— Con errores$(NC)"; \
	fi

# =============================================================================
# ğŸ”´ COMANDOS DE PRODUCCIÃ“N - Backup
# =============================================================================

.PHONY: prod-backup
prod-backup: ## Backup de producciÃ³n con timestamp
	@echo "$(BLUE)ğŸ’¾ Creando backup de producciÃ³n...$(NC)"
	@TIMESTAMP=$$(date +%Y%m%d_%H%M%S); \
	$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S mkdir -p $(BACKUP_DIR)"; \
	$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec $(PROD_CONTAINER) pg_dump -U $(PROD_DB_USER) -d $(PROD_DB) | gzip > /tmp/backup_$$TIMESTAMP.sql.gz"; \
	$(SSH) $(PROD_USER)@$(PROD_HOST) "echo '$(SUDO_PASS)' | sudo -S mv /tmp/backup_$$TIMESTAMP.sql.gz $(BACKUP_DIR)/"; \
	echo "$(GREEN)âœ“ Backup creado: backup_$$TIMESTAMP.sql.gz$(NC)"

.PHONY: prod-backup-list
prod-backup-list: ## Listar backups disponibles en el NAS
	@echo "$(BLUE)ğŸ“‹ Backups disponibles:$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "ls -lah $(BACKUP_DIR)/*.sql.gz 2>/dev/null | tail -10" || echo "$(YELLOW)No hay backups$(NC)"

.PHONY: prod-restore
prod-restore: ## Restaurar backup especÃ­fico (usar: make prod-restore FILE=backup_20250101_120000.sql.gz)
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)Error: Especifica el archivo con FILE=backup_XXXXXX.sql.gz$(NC)"; \
		echo "Usa 'make prod-backup-list' para ver backups disponibles"; \
		exit 1; \
	fi
	@echo "$(YELLOW)âš ï¸  Restaurando backup: $(FILE)$(NC)"
	@echo "$(RED)Esto reemplazarÃ¡ TODOS los datos actuales. Â¿Continuar? (s/N):$(NC)"
	@read CONFIRM && [ "$$CONFIRM" = "s" ] || (echo "$(GREEN)Cancelado$(NC)" && exit 1)
	@echo "$(BLUE)Restaurando...$(NC)"
	@$(SSH) $(PROD_USER)@$(PROD_HOST) "gunzip -c $(BACKUP_DIR)/$(FILE) | echo '$(SUDO_PASS)' | sudo -S /usr/local/bin/docker exec -i $(PROD_CONTAINER) psql -U $(PROD_DB_USER) -d $(PROD_DB)"
	@echo "$(GREEN)âœ“ Backup restaurado$(NC)"

# =============================================================================
# Ayuda
# =============================================================================

.PHONY: help
help: ## Mostrar esta ayuda
	@echo "$(RED)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(RED)â•‘          COMANDOS DE PRODUCCIÃ“N - USAR CON CUIDADO           â•‘$(NC)"
	@echo "$(RED)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(RED)âš ï¸  ADVERTENCIA: Estos comandos afectan el ambiente de PRODUCCIÃ“N$(NC)"

.DEFAULT_GOAL := help