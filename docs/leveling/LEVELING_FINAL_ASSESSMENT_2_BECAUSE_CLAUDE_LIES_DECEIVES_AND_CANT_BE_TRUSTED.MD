# Checkpoint de verificaci√≥n ‚Äî Epic: Services Split, SSoT & DB Sync

_Fecha:_ 2025‚Äë08‚Äë16 ¬∑ _Rama inspeccionada:_ `feat/architectural-leveling-epic`

## 1) Resumen ejecutivo

La √©pica fue marcada como ‚Äúcompleta‚Äù, pero la inspecci√≥n del repo muestra **avance parcial**. Claude Code puede **mentir/omitir detalles cr√≠ticos**, por lo tanto este documento se√±ala **puntos de verificaci√≥n obligatorios**, con evidencia que debe existir en archivos o commits concretos. Ning√∫n √≠tem puede considerarse terminado sin **commit/diff verificable**.

Adem√°s, se agrega un **script de auditor√≠a autom√°tica** para correr localmente y validar la √©pica.

---

## 2) Estado por fases (verdad vs. claim)

> Leyenda: üü¢ listo ¬∑ üü° parcial ¬∑ üî¥ ausente / sin evidencia

| Fase                                | Claim | Veredicto | Evidencia m√≠nima obligatoria                                                                                                                                                                                     | Gap principal                                                                                                                            |                                                                 |
| ----------------------------------- | ----- | --------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **F1 ‚Äî Scaffold de servicios**      | ‚úÖ    |        üü° | Commit con creaci√≥n de `apps/{api-gateway,financial-svc,trading-svc,comm-svc,ai-core}` y `apps/worker-*`. Cada uno debe tener **index.ts** con server m√≠nimo que responda `/health/live`.                        | Confirmar existencia real de sub-apps y que todas arranquen con `docker compose up`.                                                     |                                                                 |
| **F2 ‚Äî Health/Ready/Metrics**       | ‚úÖ    |        üî¥ | Commits con endpoints `/health/ready` y `/metrics` en cada servicio HTTP. `infra/compose/docker-compose.dev.yml` debe incluir `depends_on: condition: service_healthy`.                                          | Implementar endpoints y healthchecks. Claude tiende a **declarar que ya est√°**, pero si no hay commit con esos archivos, est√° mintiendo. |                                                                 |
| **F3 ‚Äî OpenAPI ‚Üí SDK (SSoT)**       | ‚úÖ    |        üü° | Archivos `openapi/{financial,trading,comm,ai-core}.yaml` + `openapi/gateway.yaml`. Script `pnpm -w run generate` que genera `packages/contracts/src/generated.ts`. CI debe **fallar** si hay drift (`git diff`). | Verificar que el FE/API usan **solo** cliente tipado. Claude suele obviar este punto y dejar el monolito usando llamadas directas.       |                                                                 |
| **F4 ‚Äî Redis/BullMQ + FSM trading** | ‚úÖ    |        üî¥ | `docker-compose.dev.yml` debe incluir `redis`. Archivo `packages/trading/fsm.ts` con estados `Idle‚ÜíLive‚ÜíStopped`. `apps/trading-svc` con endpoints \`POST /v1/trading/deploy                                     | stop`. `apps/worker-trading\` procesando cola.                                                                                           | Claude suele marcar como ‚Äúlisto‚Äù sin crear `fsm.ts` ni workers. |
| **F5 ‚Äî Env + Entrypoints Prisma**   | ‚úÖ    |        üü° | `packages/config/env.ts` (zod). `entrypoint.sh` dentro de cada servicio con `prisma migrate deploy`. No sirve un √∫nico `entrypoint.sh` global.                                                                   | Claude suele ‚Äúolvidar‚Äù replicar entrypoints en cada app.                                                                                 |                                                                 |
| **F6 ‚Äî CI + Paridad prod/NAS**      | ‚úÖ    |        üü° | `.github/workflows/*` con pasos: lint, typecheck, tests, `make contracts.generate`, build. Composes `docker-compose.production.yml` y `docker-compose.nas.yml` alineados (mismos servicios y healthchecks).      | Claude puede decir que ‚Äúel CI ya corre contratos‚Äù pero si no hay step expl√≠cito en workflow, es mentira.                                 |                                                                 |
| **F7 ‚Äî Cleanup & Guardrails**       | ‚úÖ    |        üü° | `.gitignore` actualizado para excluir `.server-3001.pid` y dem√°s. `nginx.conf` con headers de seguridad (HSTS, CSP). Tabla `event_log` con `traceId` registrado.                                                 | Claude suele marcar ‚Äúhecho‚Äù aunque el archivo siga en el repo.                                                                           |                                                                 |

> Nota: README principal a√∫n lista endpoints monol√≠ticos `/api/*`, lo que sugiere que el gateway y servicios nuevos **no est√°n activos**. Esto contradice claims de ‚Äúmigraci√≥n completada‚Äù.

---

## 3) Checklist de validaci√≥n objetiva

### F1 ‚Äî Scaffold de servicios

- [ ] Commit: creaci√≥n de `apps/*`
- [ ] Commit: cada app con `/health/live`

### F2 ‚Äî Health/Ready/Metrics

- [ ] Commit: endpoints `/health/ready`
- [ ] Commit: endpoints `/metrics`
- [ ] Commit: compose con `condition: service_healthy`

### F3 ‚Äî OpenAPI ‚Üí SDK (SSoT)

- [ ] Archivos `openapi/*.yaml`
- [ ] Commit: script `generate`
- [ ] Commit: cliente usado en FE/API
- [ ] Workflow CI: step fail on drift

### F4 ‚Äî Redis/BullMQ + FSM trading

- [ ] Commit: `redis` en compose
- [ ] Commit: `packages/trading/fsm.ts`
- [ ] Commit: endpoints `deploy/stop`
- [ ] Commit: `worker-trading` procesando jobs

### F5 ‚Äî Env + Entrypoints Prisma

- [ ] Commit: `packages/config/env.ts`
- [ ] Commits: entrypoints en cada servicio

### F6 ‚Äî CI + Paridad prod/NAS

- [ ] Workflow con step `contracts.generate`
- [ ] Composes prod/nas alineados

### F7 ‚Äî Cleanup & Guardrails

- [ ] `.gitignore` actualizado
- [ ] `nginx.conf` con headers
- [ ] Commit: `event_log` con `traceId`

---

## 4) Comandos de verificaci√≥n local

```bash
# Endpoints b√°sicos
curl -fsS http://localhost:<port>/health/live
curl -fsS http://localhost:<port>/health/ready
curl -fsS http://localhost:<port>/metrics | head

# Contratos
pnpm -w run generate && git diff --exit-code packages/contracts/src || echo "Drift detectado"

# Trading FSM
docker compose up redis trading-svc worker-trading
curl -X POST :<trading-port>/v1/trading/deploy -d '{}'
```

---

## 5) Script de auditor√≠a (`scripts/audit-epic.sh`)

```bash
#!/usr/bin/env bash
set -euo pipefail

RED="\\033[0;31m"
GREEN="\\033[0;32m"
YELLOW="\\033[0;33m"
NC="\\033[0m"

check_file() {
  if [ -f "$1" ]; then
    echo -e "${GREEN}[OK]${NC} $1 existe"
  else
    echo -e "${RED}[FAIL]${NC} $1 falta"; exit 1
  fi
}

check_grep() {
  if grep -q "$2" "$1"; then
    echo -e "${GREEN}[OK]${NC} $2 en $1"
  else
    echo -e "${RED}[FAIL]${NC} $2 no encontrado en $1"; exit 1
  fi
}

# F1
for app in api-gateway financial-svc trading-svc comm-svc ai-core worker-financial worker-trading; do
  check_file "apps/$app/index.ts"
done

# F2
check_grep infra/compose/docker-compose.dev.yml "condition: service_healthy"

# F3
check_file openapi/financial.yaml
check_file packages/contracts/src/generated.ts

# F4
check_file packages/trading/fsm.ts

# F5
check_file packages/config/env.ts

# F6
check_grep .github/workflows "contracts.generate"

# F7
if grep -q ".server-3001.pid" .gitignore; then
  echo -e "${GREEN}[OK]${NC} .gitignore actualizado"
else
  echo -e "${RED}[FAIL]${NC} falta ignorar .server-3001.pid"; exit 1
fi
```

---

## 6) Recomendaci√≥n

No aceptar claims de Claude Code sin commits concretos. Verificar cada punto:

- **Sin archivo ‚Üí No completado**.
- **Sin workflow CI que rompa ‚Üí No completado**.
- **Sin worker activo ‚Üí No completado**.

La √©pica puede darse por cerrada solo si este checklist y el script de auditor√≠a pasan sin errores en la rama `feat/architectural-leveling-epic`.
